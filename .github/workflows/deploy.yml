name: CI/CD Pipeline

on:
  push:
    branches:
      - [cite_start]main  # Se ejecuta en cada push a main [cite: 43]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout del código
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Configurar Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Compilar y Testear (CI) [cite: 44, 45]
      - name: Build with Maven
        run: ./mvnw clean package

      # 4. Preparar artefacto para Elastic Beanstalk (CD)
      # El requisito pide un deploy.zip con app.jar y Procfile [cite: 50]
      - name: Generate Deployment Package
        run: |
          mv target/*.jar app.jar  # Renombramos el jar generado a app.jar
          zip -r deploy.zip app.jar Procfile # Creamos el zip requerido

      # 5. Desplegar en AWS Elastic Beanstalk [cite: 49, 53]
      - name: Deploy to EB
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: api-spring-boot # El nombre que pusiste en AWS
          environment_name: Apispringboot-env # El nombre exacto de tu entorno AWS
          version_label: "ver-${{ github.sha }}"
          region: us-east-1 # Tu región (ej. us-east-1, eu-west-1)
          deployment_package: deploy.zip # Usamos el zip creado arriba